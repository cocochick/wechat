// pages/pointCloud.js
import { createScopedThreejs } from 'threejs-miniprogram'
import registerOrbit from "../../test-cases/orbit"

Component({
  /**
   * 组件的属性列表
   */
  properties: {
    point: {
      type: String,
      value: "-0.224609375 0.873046875 -0.00390625 d -0.265625 0.904296875 -0.04296875 d -0.27734375 0.943359375 -0.0546875 d -0.2890625 0.982421875 -0.05078125 d -0.224609375 0.873046875 0.0 d -0.265625 0.904296875 -0.029296875 d -0.24609375 0.953125 -0.029296875 d -0.255859375 0.9921875 -0.029296875 d -0.265625 0.904296875 0.001953125 d -0.24609375 0.953125 -0.001953125 d -0.2890625 0.984375 -0.01171875 d -0.197265625 0.876953125 -0.080078125 d -0.236328125 0.90625 -0.107421875 d -0.24609375 0.9453125 -0.119140625 d -0.255859375 0.986328125 -0.11328125 d -0.197265625 0.87890625 -0.046875 d -0.236328125 0.91015625 -0.076171875 d -0.24609375 0.94921875 -0.087890625 d -0.255859375 0.98828125 -0.087890625 d abc-0.27734375 0.943359375 -0.048828125 d -0.25390625 0.865234375 -0.046875 d -0.265625 0.904296875 -0.05078125 d -0.27734375 0.943359375 -0.060546875 d -0.255859375 0.990234375 -0.072265625 d -0.27734375 0.943359375 -0.03125 d -0.265625 0.89453125 -0.142578125 d -0.24609375 0.943359375 -0.134765625 d -0.255859375 0.98046875 -0.15625 d -0.25390625 0.859375 -0.09765625 d -0.265625 0.8984375 -0.103515625 d -0.24609375 0.947265625 -0.103515625 d -0.255859375 0.982421875 -0.138671875 d -0.265625 0.99609375 -0.26953125 d abc-0.294921875 0.89453125 -0.037109375 d -0.27734375 0.943359375 -0.05078125 d -0.2890625 0.982421875 -0.05078125 d -0.27734375 0.9375 -0.119140625 d -0.25390625 0.865234375 0.005859375 d -0.265625 0.904296875 -0.052734375 d -0.27734375 0.939453125 -0.091796875 d -0.255859375 0.990234375 -0.08203125 d -0.232421875 1.0390625 0.04296875 d abc-0.265625 0.873046875 0.2421875 d -0.306640625 0.9140625 0.19921875 d -0.3203125 0.955078125 0.189453125 d -0.169921875 0.880859375 0.09375 d -0.236328125 0.90234375 0.14453125 d -0.27734375 0.9375 0.115234375 d -0.3203125 0.970703125 0.083984375 d abc-0.087890625 0.9375 0.033203125 d -0.060546875 0.982421875 0.00390625 d -0.056640625 0.896484375 0.087890625 d -0.353515625 0.599609375 -0.63671875 d -0.337890625 0.7890625 -0.482421875 d -0.3515625 0.82421875 -0.498046875 d -0.056640625 0.8984375 0.05078125 d -0.029296875 0.943359375 -0.00390625 d -0.337890625 0.55078125 -0.7421875 d -0.3203125 0.47265625 -0.8515625 d -0.3828125 0.46875 -0.724609375 d -0.337890625 0.708984375 -0.591796875 d -0.3671875 0.115234375 -0.81640625 d -0.05859375 0.9375 0.08203125 d -0.060546875 0.98046875 0.041015625 d -0.3671875 0.193359375 0.80078125 d -0.353515625 0.0 -0.8828125 d -0.03125 0.98046875 -0.08984375 d -0.03125 0.984375 -0.287109375 d abc-0.087890625 0.93359375 0.09375 d -0.18359375 0.9609375 -0.09765625 d -0.255859375 0.87109375 0.474609375 d -0.30078125 0.91015625 0.466796875 d -0.345703125 0.92578125 0.498046875 d -0.05859375 0.939453125 0.0625 d -0.091796875 0.978515625 0.052734375 d -0.095703125 1.017578125 0.06640625 d -0.099609375 1.060546875 0.05859375 d -0.103515625 1.1015625 -0.005859375 d -0.177734375 0.92578125 0.05078125 d -0.123046875 0.9765625 0.029296875 d -0.16015625 1.01171875 0.033203125 d -0.1328125 1.056640625 0.0390625 d -0.138671875 1.09765625 0.03515625 d -0.123046875 0.97265625 0.087890625 d -0.16015625 1.01171875 0.05859375 d -0.166015625 1.052734375 0.03515625 d -0.173828125 1.09375 0.001953125 d -0.20703125 0.919921875 -0.041015625 d -0.21484375 0.958984375 -0.068359375 d -0.19140625 1.00390625 -0.083984375 d -0.19921875 1.04296875 -0.099609375 d -0.20703125 1.08203125 -0.10546875 d -0.236328125 0.912109375 -0.02734375 d -0.21484375 0.958984375 -0.0625 d -0.224609375 0.998046875 -0.076171875 d -0.232421875 1.037109375 -0.087890625 d -0.2421875 1.078125 -0.08203125 d -0.177734375 0.919921875 -0.115234375 d -0.18359375 0.958984375 -0.126953125 d -0.19140625 0.998046875 -0.13671875 d -0.19921875 1.037109375 -0.142578125 d -0.2421875 1.072265625 -0.138671875 d -0.146484375 0.921875 -0.1328125 d -0.154296875 0.962890625 -0.1328125 d -0.16015625 1.00390625 -0.134765625 d -0.166015625 1.044921875 -0.13671875 d -0.20703125 1.076171875 -0.154296875 d -0.177734375 0.92578125 -0.0546875 d -0.18359375 0.962890625 -0.0859375 d -0.19140625 1.001953125 -0.10546875 d -0.166015625 1.046875 -0.11328125 d -0.173828125 1.083984375 -0.14453125 d -0.099609375 1.03515625 -0.232421875 d -0.138671875 1.052734375 -0.3125 d -0.1796875 1.087890625 -0.322265625 d -0.27734375 1.01171875 -0.353515625 d -0.287109375 1.03515625 -0.404296875 d -0.1328125 1.01171875 0.310546875 d -0.099609375 1.01953125 0.296875 d -0.103515625 1.0703125 0.267578125 d -0.12890625 0.94140625 0.38671875 d -0.099609375 1.001953125 0.349609375 d -0.03515625 1.07421875 0.263671875 d 0.03515625 1.1328125 0.1875 d 0.07421875 1.173828125 0.171875 d -0.064453125 0.984375 0.279296875 d -0.033203125 1.033203125 0.265625 d 0.0 1.08203125 0.234375 d 0.072265625 1.12890625 0.201171875 d 0.07421875 1.16796875 0.20703125 d -0.064453125 0.98828125 0.26171875 d -0.033203125 1.037109375 0.24609375 d abc-0.18359375 0.966796875 0.013671875 d -0.16015625 1.01171875 0.046875 d -0.19921875 1.046875 0.044921875 d -0.20703125 1.0859375 0.05078125 d -0.21484375 1.126953125 -0.001953125 d -0.146484375 0.9296875 0.056640625 d -0.154296875 0.96875 0.087890625 d -0.16015625 1.005859375 0.109375 d -0.1328125 1.048828125 0.130859375 d -0.138671875 1.091796875 0.125 d -0.146484375 0.927734375 0.083984375 d -0.154296875 0.96484375 0.119140625 d -0.12890625 1.0078125 0.134765625 d -0.099609375 1.0546875 0.1171875 d -0.068359375 1.103515625 0.052734375 d -0.03515625 1.146484375 -0.068359375 d -0.177734375 0.921875 0.0859375 d -0.21484375 0.9375 0.2109375 d -0.03125 1.0234375 -0.04296875 d -0.033203125 1.06640625 -0.01953125 d 0.0 1.107421875 -0.02734375 d 0.0 1.14453125 -0.087890625 d -0.146484375 0.92578125 0.109375 d 0.03125 0.970703125 -0.16015625 d 0.0 1.0234375 -0.0625 d -0.033203125 1.064453125 -0.044921875 d -0.03515625 1.10546875 -0.041015625 d 0.03515625 1.146484375 -0.060546875 d 0.0 0.98046875 -0.083984375 d -0.03125 1.021484375 -0.07421875 d -0.033203125 1.060546875 -0.09765625 d -0.03515625 1.087890625 -0.19921875 d -0.107421875 1.07421875 -0.392578125 d -0.416015625 0.89453125 0.27734375 d -0.099609375 1.0 -0.357421875 d -0.138671875 1.0546875 -0.3046875 d -0.1796875 1.099609375 -0.275390625 d -0.22265625 1.140625 -0.251953125 d -0.095703125 1.01171875 -0.13671875 d -0.1328125 1.048828125 -0.14453125 d -0.138671875 1.0859375 -0.171875 d -0.1796875 1.115234375 -0.203125 d -0.19921875 1.029296875 -0.193359375 d -0.2421875 1.03515625 -0.310546875 d -0.21484375 1.06640625 -0.369140625 d -0.166015625 0.98046875 -0.3828125 d -0.20703125 1.025390625 -0.361328125 d -0.1796875 1.087890625 -0.318359375 d -0.091796875 0.880859375 0.427734375 d -0.095703125 0.9375 0.40234375 d -0.1171875 0.849609375 0.392578125 d -0.091796875 0.884765625 0.419921875 d -0.095703125 0.908203125 0.46484375 d -0.123046875 0.705078125 0.67578125 d -0.2890625 0.9765625 -0.123046875 d -0.232421875 1.041015625 -0.00390625 d -0.173828125 1.08984375 0.08203125 d -0.44921875 0.0 1.0859375 d -0.4296875 0.94921875 0.482421875 d 0.03125 0.9609375 -0.212890625 d -0.384765625 0.64453125 0.69921875 d -0.400390625 0.30078125 -0.94140625 d -0.416015625 0.857421875 -0.564453125 d -0.39453125 1.021484375 0.345703125 d abc-0.224609375 0.96484375 -0.265625 d -0.232421875 1.01171875 -0.2421875 d -0.27734375 1.0390625 -0.26171875 d -0.2421875 1.00390625 -0.40234375 d -0.142578125 0.994140625 -0.556640625 d -0.185546875 1.02734375 -0.568359375 d -0.146484375 0.876953125 0.3125 d -0.154296875 0.923828125 0.302734375 d -0.19140625 0.96484375 0.28515625 d -0.19921875 1.009765625 0.27734375 d -0.416015625 0.9453125 0.400390625 d -0.142578125 0.998046875 -0.55078125 d -0.185546875 1.044921875 -0.53515625 d -0.177734375 0.861328125 0.341796875 d -0.18359375 0.90625 0.333984375 d -0.224609375 0.9609375 0.279296875 d -0.333984375 0.978515625 0.263671875 d -0.380859375 0.982421875 0.33984375 d -0.072265625 1.083984375 -0.369140625 d -0.07421875 1.14453125 -0.3125 d -0.177734375 0.83203125 0.408203125 d -0.24609375 0.845703125 0.439453125 d -0.3203125 0.896484375 0.3828125 d -0.3671875 0.931640625 0.3671875 d -0.416015625 0.908203125 0.478515625 d -0.072265625 1.103515625 -0.30859375 d -0.1484375 1.158203125 -0.228515625 d -0.091796875 0.978515625 0.044921875 d -0.064453125 1.01953125 -0.087890625 d -0.06640625 1.044921875 -0.19921875 d -0.068359375 1.08203125 -0.2265625 d -0.072265625 1.125 -0.216796875 d -0.1484375 1.16796875 -0.162109375 d -0.19140625 1.0078125 -0.017578125 d -0.232421875 1.0390625 -0.044921875 d -0.173828125 1.09375 -0.033203125 d -0.107421875 1.142578125 -0.03125 d 0.27734375 0.568359375 0.91015625 d -0.03515625 1.033203125 -0.3984375 d -0.4296875 0.900390625 0.568359375 d -0.03125 1.013671875 -0.15234375 d -0.033203125 1.01953125 -0.3125 d -0.03515625 1.05078125 -0.349609375 d -0.466796875 0.826171875 0.646484375 d -0.400390625 0.349609375 0.828125 d -0.416015625 0.681640625 0.642578125 d -0.43359375 0.712890625 0.6640625 d -0.44921875 0.611328125 0.806640625 d abc-0.138671875 1.06640625 -0.267578125 d -0.142578125 1.087890625 -0.341796875 d -0.111328125 1.107421875 -0.419921875 d -0.22265625 0.9765625 -0.640625 d -0.23046875 1.03125 -0.62890625 d -0.23828125 1.072265625 -0.640625 d -0.21484375 1.005859375 -0.51171875 d -0.185546875 1.076171875 -0.470703125 d -0.19140625 1.1171875 -0.4765625 d -0.19921875 1.154296875 -0.49609375 d -0.185546875 1.12109375 -0.3515625 d -0.154296875 1.150390625 -0.408203125 d 0.0 1.0546875 -0.453125 d -0.037109375 1.056640625 -0.544921875 d -0.345703125 1.16015625 -0.216796875 d -0.03515625 1.0703125 -0.279296875 d -0.072265625 1.125 -0.21484375 d -0.07421875 1.171875 -0.193359375 d -0.076171875 1.2109375 -0.201171875 d -0.0390625 1.2421875 -0.271484375 d -0.1328125 1.0546875 -0.080078125 d -0.138671875 1.091796875 -0.115234375 d -0.107421875 1.138671875 -0.09765625 d -0.07421875 1.18359375 -0.080078125 d -0.076171875 1.224609375 -0.091796875 d -0.080078125 1.2578125 -0.169921875 d -0.166015625 1.046875 -0.115234375 d -0.20703125 1.083984375 -0.095703125 d -0.1796875 1.1328125 -0.0703125 d -0.111328125 1.18359375 -0.013671875 d -0.076171875 1.228515625 -0.013671875 d -0.080078125 1.265625 -0.080078125 d -0.19921875 1.037109375 -0.150390625 d -0.2421875 1.07421875 -0.107421875 d -0.21484375 1.126953125 -0.0546875 d -0.185546875 1.173828125 -0.01171875 d -0.115234375 1.224609375 0.01953125 d -0.119140625 1.265625 0.013671875 d -0.232421875 1.03515625 -0.10546875 d -0.27734375 1.056640625 -0.177734375 d -0.359375 1.083984375 -0.11328125 d -0.408203125 1.11328125 -0.09375 d -0.423828125 1.150390625 -0.109375 d -0.19921875 1.033203125 0.169921875 d -0.20703125 1.064453125 0.224609375 d -0.4296875 0.646484375 -0.845703125 d -0.408203125 0.84765625 -0.728515625 d -0.408203125 0.94921875 -0.587890625 d -0.423828125 0.974609375 -0.619140625 d -0.4375 0.958984375 -0.708984375 d -0.4609375 0.943359375 -0.640625 d -0.515625 0.822265625 -0.8203125 d abc-0.1484375 1.1484375 -0.2734375 d -0.23046875 1.150390625 -0.373046875 d -0.23828125 1.171875 -0.431640625 d -0.205078125 1.21875 -0.443359375 d -0.185546875 1.119140625 -0.357421875 d -0.19140625 1.16015625 -0.361328125 d -0.19921875 1.201171875 -0.365234375 d -0.21484375 1.09375 -0.27734375 d -0.185546875 1.138671875 -0.291015625 d -0.19140625 1.1796875 -0.291015625 d -0.23828125 1.21484375 -0.291015625 d -0.205078125 1.265625 -0.27734375 d -0.142578125 1.12890625 -0.146484375 d -0.408203125 1.115234375 -0.052734375 d -0.26953125 1.1796875 -0.22265625 d -0.27734375 1.21484375 -0.25 d -0.287109375 1.25390625 -0.26171875 d -0.21484375 1.111328125 -0.19140625 d -0.185546875 1.16015625 -0.181640625 d -0.384765625 1.115234375 -0.349609375 d -0.318359375 1.197265625 -0.28515625 d -0.328125 1.232421875 -0.30859375 d -0.287109375 1.1015625 -0.14453125 d -0.37109375 1.126953125 0.068359375 d -0.423828125 1.15625 0.0078125 d -0.4375 1.185546875 -0.14453125 d -0.451171875 1.205078125 -0.25390625 d -0.46484375 1.212890625 -0.37890625 d -0.37109375 1.119140625 0.154296875 d -0.423828125 1.146484375 0.1484375 d -0.4375 1.185546875 0.13671875 d -0.451171875 1.2265625 0.119140625 d -0.46484375 1.271484375 0.01171875 d -0.37109375 1.107421875 0.220703125 d -0.384765625 1.140625 0.25390625 d -0.396484375 1.177734375 0.26953125 d -0.41015625 1.21875 0.26171875 d -0.337890625 1.29296875 0.2109375 d -0.22265625 1.123046875 0.322265625 d -0.154296875 1.087890625 0.552734375 d -0.19921875 1.240234375 0.1953125 d -0.205078125 1.294921875 0.068359375 d 0.0 1.3515625 0.064453125 d -0.1796875 1.12890625 0.115234375 d -0.22265625 1.162109375 0.126953125 d -0.19140625 1.208984375 0.11328125 d -0.318359375 1.216796875 0.189453125 d 0.041015625 1.302734375 -0.146484375 d -0.21484375 1.119140625 0.13671875 d -0.22265625 1.16015625 0.138671875 d -0.23046875 1.201171875 0.134765625 d 0.0 1.09765625 -0.458984375 d -0.0390625 1.259765625 0.1640625 d -0.041015625 1.306640625 0.107421875 d -0.083984375 1.3515625 -0.01171875 d 0.0 1.330078125 -0.248046875 d -0.07421875 1.1640625 -0.236328125 d -0.076171875 1.208984375 -0.216796875 d -0.119140625 1.255859375 -0.1640625 d -0.119140625 1.248046875 0.21484375 d -0.380859375 1.287109375 -0.177734375 d 0.080078125 0.978515625 -0.80859375 d -0.41015625 1.232421875 0.19140625 d "
    },
  },

  /**
   * 组件的初始数据
   */
  data: {
  },

  attached() {
    var that = this;
    this.createSelectorQuery()
      .select('#webgl')
      .node()
      .exec((res) => {
        const canvas = res[0].node
        this.canvas = canvas
        const THREE = createScopedThreejs(canvas)

        this.initModel(THREE);
        
        const points = this.handleMatrixStream(this.properties.point);
        this.geometry = new THREE.BufferGeometry();//创建图形对象
        this.geometry.attributes.position = new THREE.BufferAttribute(new Float32Array(points[0]), 3);
        this.points = new THREE.Points(this.geometry, this.material);//将上述对象配置到点模型对象上
        this.scene.add(this.points); 

        function animate() {
          canvas.requestAnimationFrame(animate);
          that.controls.update()
          that.renderer.render(that.scene, that.camera);
        }
        
        animate();
        for (let i = 0; i < points.length; ++i) {
          let interval = points.length / 60 * 1000;
          setTimeout(() => {
            that.geometry.attributes.position = new THREE.BufferAttribute(new Float32Array(points[i]), 3);
          }, interval * i);
        }
      });
  },

  /**
   * 组件的方法列表
   */
  methods: {
    touchStart(e) {
      this.canvas.dispatchTouchEvent({...e, type:'touchstart'})
    },
    touchMove(e) {
      this.canvas.dispatchTouchEvent({...e, type:'touchmove'})
    },
    touchEnd(e) {
      this.canvas.dispatchTouchEvent({...e, type:'touchend'})
    },
    handleMatrixStream(stream) {
      let frames = stream.split("abc").filter(item => item != '');
      var res = [];
      frames.forEach((frame) => {
        let frameBox = []
        frame = frame.split(" d ").filter(item => item != '');
        frame.forEach((point) => {
          point = point.split(" ").filter(item => item != '');
          point.forEach((position) => {
            frameBox.push(parseFloat(position));
          }); 
        });
        res.push(frameBox);
      });
      return res;
    },

    initModel(THREE) {
      this.camera = new THREE.PerspectiveCamera(45, this.canvas.width / this.canvas.height, 0.01, 100);
      this.camera.position.set(3, 3, 3);
      // this.camera.lookAt(new THREE.Vector3(100000, 1101000, 10120.120));

      this.scene = new THREE.Scene();
      this.scene.background = new THREE.Color(0xe0e0e0);

      var light = new THREE.HemisphereLight(0xffffff, 0x444444);
      light.position.set(0, 10, 0);
      this.scene.add(light);
      light = new THREE.DirectionalLight(0xffffff);
      light.position.set(0, 20, 10);
      this.scene.add(light);

          // ground
      var mesh = new THREE.Mesh(new THREE.PlaneBufferGeometry(2000, 2000), new THREE.MeshPhongMaterial({ color: 0x999999, depthWrite: false }));
      mesh.rotation.x = - Math.PI / 2;
      this.scene.add(mesh);
      var grid = new THREE.GridHelper(200, 40, 0x000000, 0x000000);
      grid.material.opacity = 0.2;
      grid.material.transparent = true;
      this.scene.add(grid);
    
      this.material = new THREE.PointsMaterial({
        color: 0x00ffff,//模型颜色
        size: 0.05//模型大小
      });//配置模型的材质对象        

      this.renderer = new THREE.WebGLRenderer({ antialias: true });
      this.renderer.setPixelRatio(wx.getSystemInfoSync().pixelRatio);
      this.renderer.setSize(this.canvas.width, this.canvas.height);
      this.renderer.gammaOutput = true;
      this.renderer.gammaFactor = 2.2;

      const { OrbitControls } = registerOrbit(THREE)
      this.controls = new OrbitControls( this.camera, this.renderer.domElement );
      this.controls.update();
    },

  }
})
